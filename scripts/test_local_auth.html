<!DOCTYPE html>
<html>
<head>
    <title>测试本地认证配置</title>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .status { 
            padding: 5px 10px; 
            border-radius: 4px; 
            display: inline-block;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover { background: #0056b3; }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>🔍 本地Firebase认证测试</h1>
    
    <div class="test-section">
        <h2>1. 当前访问信息</h2>
        <p>URL: <span id="current-url"></span></p>
        <p>Origin: <span id="current-origin"></span></p>
        <p>Port: <span id="current-port"></span></p>
    </div>

    <div class="test-section">
        <h2>2. Firebase配置检查</h2>
        <div id="firebase-config"></div>
    </div>

    <div class="test-section">
        <h2>3. 认证测试</h2>
        <button onclick="testGoogleSignIn()">测试Google登录</button>
        <button onclick="testEmailSignIn()">测试邮箱登录</button>
        <button onclick="testAnonymousSignIn()">测试匿名登录</button>
        <div id="auth-result"></div>
    </div>

    <div class="test-section">
        <h2>4. 错误诊断</h2>
        <div id="error-diagnosis"></div>
    </div>

    <script type="module">
        // 显示当前URL信息
        document.getElementById('current-url').textContent = window.location.href;
        document.getElementById('current-origin').textContent = window.location.origin;
        document.getElementById('current-port').textContent = window.location.port || '80';

        // 检查Firebase配置
        window.checkFirebaseConfig = function() {
            const configDiv = document.getElementById('firebase-config');
            
            // 这里应该从你的实际Firebase配置中读取
            const expectedConfig = {
                authDomain: 'loverecipejournal-41ad5.firebaseapp.com',
                projectId: 'loverecipejournal-41ad5',
                expectedRedirectUri: `${window.location.origin}/__/auth/handler`
            };
            
            configDiv.innerHTML = `
                <p>Auth Domain: <code>${expectedConfig.authDomain}</code></p>
                <p>Project ID: <code>${expectedConfig.projectId}</code></p>
                <p>预期的重定向URI: <code>${expectedConfig.expectedRedirectUri}</code></p>
                <p class="status warning">⚠️ 请确保在Google Console中添加了上述重定向URI</p>
            `;
        };

        // 测试Google登录
        window.testGoogleSignIn = function() {
            const resultDiv = document.getElementById('auth-result');
            resultDiv.innerHTML = '<p class="status warning">正在测试Google登录...</p>';
            
            // 模拟OAuth流程
            const authUrl = 'https://accounts.google.com/o/oauth2/v2/auth';
            const params = new URLSearchParams({
                client_id: 'YOUR_CLIENT_ID.apps.googleusercontent.com',
                redirect_uri: `${window.location.origin}/__/auth/handler`,
                response_type: 'code',
                scope: 'email profile',
                access_type: 'offline',
                prompt: 'select_account'
            });
            
            resultDiv.innerHTML = `
                <p class="status warning">OAuth URL将会是:</p>
                <pre>${authUrl}?${params.toString()}</pre>
                <p>如果出现redirect_uri_mismatch错误，说明上述redirect_uri未在Google Console中配置</p>
            `;
        };

        // 错误诊断
        window.diagnoseError = function(error) {
            const diagnosisDiv = document.getElementById('error-diagnosis');
            let diagnosis = '';
            
            if (error.includes('redirect_uri_mismatch')) {
                diagnosis = `
                    <h3>❌ 重定向URI不匹配</h3>
                    <p>解决方案：</p>
                    <ol>
                        <li>打开 <a href="https://console.cloud.google.com/apis/credentials?project=loverecipejournal-41ad5" target="_blank">Google Cloud Console</a></li>
                        <li>编辑你的OAuth 2.0客户端ID</li>
                        <li>添加: <code>${window.location.origin}/__/auth/handler</code></li>
                        <li>添加: <code>${window.location.origin}</code></li>
                    </ol>
                `;
            } else if (error.includes('People API')) {
                diagnosis = `
                    <h3>❌ People API未启用</h3>
                    <p>解决方案：</p>
                    <ol>
                        <li>打开 <a href="https://console.cloud.google.com/apis/library/people.googleapis.com?project=loverecipejournal-41ad5" target="_blank">People API页面</a></li>
                        <li>点击"启用"按钮</li>
                        <li>或者在代码中减少权限范围，只使用'email'而不是'email profile'</li>
                    </ol>
                `;
            } else if (error.includes('unauthorized')) {
                diagnosis = `
                    <h3>❌ 未授权的客户端</h3>
                    <p>可能原因：</p>
                    <ol>
                        <li>OAuth同意屏幕未正确配置</li>
                        <li>测试用户未添加（如果是测试模式）</li>
                        <li>客户端ID配置错误</li>
                    </ol>
                `;
            }
            
            diagnosisDiv.innerHTML = diagnosis || '<p>请提供具体错误信息以便诊断</p>';
        };

        // 初始化检查
        checkFirebaseConfig();
    </script>
</body>
</html>