# ğŸ—ï¸ çˆ±å¿ƒé£Ÿè°±æœ¬åœ°äº‘ç«¯å¼‚æ­¥æ•°æ®åŒæ­¥æ¶æ„è¯¦è§£

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

è¿™æ˜¯ä¸€ä»½è¯¦ç»†çš„æŠ€æœ¯æ¶æ„æ–‡æ¡£ï¼Œæè¿°äº†"çˆ±å¿ƒé£Ÿè°±"åº”ç”¨çš„æœ¬åœ°äº‘ç«¯å¼‚æ­¥æ•°æ®åŒæ­¥ç³»ç»Ÿã€‚è¯¥ç³»ç»Ÿä¸“ä¸º**æç®€é«˜çº§**çš„ç”¨æˆ·ä½“éªŒè®¾è®¡ï¼Œå®ç°äº†"æœ¬åœ°ä¼˜å…ˆï¼Œäº‘ç«¯åŒæ­¥"çš„æ•°æ®ç®¡ç†ç­–ç•¥ã€‚

---

## ğŸ¯ è®¾è®¡ç›®æ ‡ä¸é¢„æœŸç»“æœ

### ç”¨æˆ·æœŸæœ›çš„æ ¸å¿ƒä½“éªŒ
1. **ç§’å¼€é€Ÿåº¦** - åº”ç”¨å¯åŠ¨ç«‹å³æ˜¾ç¤ºå†…å®¹ï¼Œæ— ç­‰å¾…æ—¶é—´
2. **ç¦»çº¿å¯ç”¨** - ç½‘ç»œæ–­å¼€æ—¶ä»å¯æ­£å¸¸æµè§ˆå’Œæ“ä½œ
3. **æ™ºèƒ½åŒæ­¥** - æ•°æ®è‡ªåŠ¨åŒæ­¥ï¼Œç”¨æˆ·æ— æ„ŸçŸ¥
4. **å†²çªå¤„ç†** - å¤šè®¾å¤‡æ•°æ®å†²çªæ—¶æ™ºèƒ½å¤„ç†
5. **æ›´æ–°æé†’** - æœ‰æ–°å†…å®¹æ—¶ä¼˜é›…æç¤ºï¼Œä¸æ‰“æ‰°

### MVPé˜¶æ®µå®ç°ç›®æ ‡
- âœ… æœ¬åœ°ç¼“å­˜ä¼˜å…ˆå“åº”ï¼ˆ<200msï¼‰
- âœ… åå°æ™ºèƒ½åŒæ­¥ï¼ˆç”¨æˆ·æ— æ„ŸçŸ¥ï¼‰
- âœ… ç½‘ç»œé‡è¯•æœºåˆ¶ï¼ˆæé«˜æˆåŠŸç‡ï¼‰
- âœ… åŸºç¡€æ›´æ–°æ£€æµ‹ï¼ˆçº¢ç‚¹æç¤ºï¼‰
- âœ… å•ç”¨æˆ·æµ‹è¯•å·¥å…·ï¼ˆæ— éœ€åŒè´¦æˆ·ï¼‰

---

## ğŸ›ï¸ æ•´ä½“æ¶æ„è®¾è®¡

### æ¶æ„å›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸ“± Flutter UI Layer                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   ä¸»é¡µèœè°±å±•ç¤º    â”‚  â”‚   æˆ‘çš„èœè°±ç®¡ç†    â”‚  â”‚   æ”¶è—åŠŸèƒ½     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 ğŸ® State Management Layer                   â”‚
â”‚         (Riverpod Providers + StateNotifiers)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ RecipeProvider  â”‚  â”‚CachedRecipeP..  â”‚  â”‚FavoritesP...  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  âš¡ Business Logic Layer                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚            ğŸ“¦ CachedRecipeService                       â”‚ â”‚
â”‚  â”‚         (æ ¸å¿ƒåŒæ­¥åè°ƒå™¨ - Core Sync Coordinator)         â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚  ğŸ”„ åŒæ­¥ç­–ç•¥:                                           â”‚ â”‚
â”‚  â”‚  1. ç«‹å³è¿”å›æœ¬åœ°ç¼“å­˜æ•°æ® (<200ms)                       â”‚ â”‚
â”‚  â”‚  2. åå°æ£€æŸ¥äº‘ç«¯æ›´æ–° (å¼‚æ­¥)                             â”‚ â”‚
â”‚  â”‚  3. æ™ºèƒ½åˆå¹¶å·®å¼‚æ•°æ®                                    â”‚ â”‚
â”‚  â”‚  4. é€šçŸ¥UIæ›´æ–° (StateNotifier)                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â–¼                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ğŸ“¦ Local Storage       â”‚              â”‚    â˜ï¸ Cloud Storage      â”‚
â”‚   (Hive Database)        â”‚              â”‚   (Firebase Firestore)  â”‚
â”‚                         â”‚    ğŸ”„ SYNC   â”‚                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚     â‡„        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚  local_recipes      â”‚ â”‚              â”‚ â”‚   users/{uid}/      â”‚ â”‚
â”‚ â”‚  local_favorites    â”‚ â”‚              â”‚ â”‚    recipes/         â”‚ â”‚
â”‚ â”‚  preset_recipes     â”‚ â”‚              â”‚ â”‚  user_favorites     â”‚ â”‚
â”‚ â”‚  cache_metadata     â”‚ â”‚              â”‚ â”‚  preset_recipes     â”‚ â”‚
â”‚ â”‚  recipe_updates     â”‚ â”‚              â”‚ â”‚   (Rootç”¨æˆ·)        â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚              â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š æ•°æ®æµå‘è¯¦è§£

### 1ï¸âƒ£ è¯»å–æ•°æ®æµ (Data Read Flow)

```mermaid
sequenceDiagram
    participant UI as ğŸ“± UIç»„ä»¶
    participant Provider as ğŸ® Provider
    participant Cache as ğŸ“¦ CacheService
    participant Hive as ğŸ’¾ Hiveæœ¬åœ°
    participant Firebase as â˜ï¸ Firebase

    UI->>Provider: è¯·æ±‚èœè°±æ•°æ®
    Provider->>Cache: getUserRecipes(userId)
    
    Note over Cache: ğŸš€ æœ¬åœ°ä¼˜å…ˆç­–ç•¥
    Cache->>Hive: ç«‹å³è·å–æœ¬åœ°æ•°æ®
    Hive-->>Cache: è¿”å›æœ¬åœ°èœè°±[]
    Cache-->>Provider: ç«‹å³è¿”å›æœ¬åœ°æ•°æ®
    Provider-->>UI: ğŸ“± ç§’é€Ÿæ˜¾ç¤ºå†…å®¹
    
    Note over Cache: ğŸ”„ åå°å¼‚æ­¥æ£€æŸ¥
    Cache->>Firebase: åå°æ£€æŸ¥äº‘ç«¯æ›´æ–°
    Firebase-->>Cache: è¿”å›äº‘ç«¯èœè°±[]
    Cache->>Cache: æ¯”è¾ƒæœ¬åœ°vsäº‘ç«¯ç‰ˆæœ¬
    
    alt å‘ç°æ›´æ–°
        Cache->>Hive: æ›´æ–°æœ¬åœ°ç¼“å­˜
        Cache->>Provider: é€šçŸ¥æ•°æ®å˜åŒ–
        Provider->>UI: ğŸ”´ æ˜¾ç¤ºæ›´æ–°æ ‡è®°
    else æ— æ›´æ–°
        Cache->>Cache: è®°å½•æ£€æŸ¥æ—¶é—´
    end
```

### 2ï¸âƒ£ å†™å…¥æ•°æ®æµ (Data Write Flow)

```mermaid
sequenceDiagram
    participant UI as ğŸ“± UIç»„ä»¶
    participant Provider as ğŸ® Provider
    participant Cache as ğŸ“¦ CacheService
    participant Hive as ğŸ’¾ Hiveæœ¬åœ°
    participant Firebase as â˜ï¸ Firebase

    UI->>Provider: ä¿å­˜/æ”¶è—èœè°±
    Provider->>Cache: saveRecipe(recipe)
    
    Note over Cache: ğŸš€ åŒå†™ç­–ç•¥
    Cache->>Hive: ç«‹å³ä¿å­˜åˆ°æœ¬åœ°
    Hive-->>Cache: âœ… æœ¬åœ°ä¿å­˜æˆåŠŸ
    Cache-->>Provider: ç«‹å³è¿”å›æˆåŠŸ
    Provider-->>UI: ğŸ“± ç¬é—´å“åº”ç”¨æˆ·
    
    Note over Cache: â˜ï¸ å¼‚æ­¥äº‘ç«¯åŒæ­¥
    par å¹¶å‘æ‰§è¡Œ
        Cache->>Firebase: å¼‚æ­¥ä¿å­˜åˆ°äº‘ç«¯
        Firebase-->>Cache: âœ… äº‘ç«¯ä¿å­˜æˆåŠŸ
        Cache->>Hive: æ ‡è®°åŒæ­¥å®Œæˆ
    and é‡è¯•æœºåˆ¶
        Cache->>Cache: ç½‘ç»œå¤±è´¥é‡è¯•(2æ¬¡)
        Cache->>Hive: è®°å½•åŒæ­¥çŠ¶æ€
    end
```

### 3ï¸âƒ£ ç™»å½•åŒæ­¥æµ (Login Sync Flow)

```mermaid
sequenceDiagram
    participant Auth as ğŸ” AuthService
    participant Cache as ğŸ“¦ CacheService
    participant Hive as ğŸ’¾ Hiveæœ¬åœ°
    participant Firebase as â˜ï¸ Firebase
    participant UI as ğŸ“± UIç•Œé¢

    Auth->>Auth: ç”¨æˆ·ç™»å½•æˆåŠŸ
    
    Note over Auth: ğŸš€ æ™ºèƒ½åŒæ­¥ç­–ç•¥
    par å¹¶å‘æ•°æ®åŒæ­¥
        Auth->>Cache: åŒæ­¥ç”¨æˆ·èœè°±
        Cache->>Firebase: è·å–ç”¨æˆ·èœè°±
        Firebase-->>Cache: è¿”å›äº‘ç«¯èœè°±
        Cache->>Hive: æ›´æ–°æœ¬åœ°ç¼“å­˜
    and
        Auth->>Cache: åŒæ­¥æ”¶è—æ•°æ®
        Cache->>Firebase: è·å–æ”¶è—åˆ—è¡¨
        Firebase-->>Cache: è¿”å›æ”¶è—æ•°æ®
        Cache->>Hive: æ›´æ–°æ”¶è—ç¼“å­˜
    and
        Auth->>Cache: åŒæ­¥é¢„è®¾èœè°±
        Cache->>Firebase: è·å–Rooté¢„è®¾
        Firebase-->>Cache: è¿”å›12ä¸ªé¢„è®¾
        Cache->>Hive: ç¼“å­˜é¢„è®¾èœè°±
    end
    
    Note over Cache: âš¡ åŒæ­¥å®Œæˆ(3ç§’å†…)
    Cache-->>Auth: æ‰€æœ‰æ•°æ®åŒæ­¥å®Œæˆ
    Auth->>UI: è§¦å‘ç•Œé¢æ•°æ®åˆ·æ–°
```

---

## ğŸ’¾ æœ¬åœ°å­˜å‚¨æ¶æ„ (Local Storage)

### Hiveæ•°æ®åº“è®¾è®¡

#### 1. èœè°±ç¼“å­˜ (Recipe Cache)
```dart
// Box: local_recipes
Box<Recipe> _recipesBox = await Hive.openBox<Recipe>('local_recipes');

æ•°æ®ç»“æ„:
{
  "recipe_id_1": Recipe{
    id: "recipe_id_1",
    name: "çº¢çƒ§è‚‰",
    createdBy: "user_id", 
    updatedAt: DateTime,
    isPreset: false,
    ...
  }
}

å­˜å‚¨ç­–ç•¥:
âœ… ç”¨æˆ·åˆ›å»ºçš„èœè°±
âœ… æ”¶è—çš„èœè°±è¯¦æƒ…
âœ… é¢„è®¾èœè°±å‰¯æœ¬
âœ… åˆ†äº«è·å¾—çš„èœè°±
```

#### 2. æ”¶è—ç®¡ç† (Favorites)
```dart
// Box: local_favorites  
Box<List<String>> _favoritesBox = await Hive.openBox<List<String>>('local_favorites');

æ•°æ®ç»“æ„:
{
  "user_id_1": ["recipe_id_1", "recipe_id_2", "recipe_id_3"],
  "user_id_2": ["recipe_id_4", "recipe_id_5"]
}

ç®¡ç†åŠŸèƒ½:
âœ… å¿«é€Ÿæ”¶è—çŠ¶æ€æ£€æŸ¥
âœ… æœ¬åœ°æ”¶è—åˆ—è¡¨ç¼“å­˜
âœ… æ”¯æŒå¤šç”¨æˆ·æ”¶è—éš”ç¦»
```

#### 3. å…ƒæ•°æ®ç®¡ç† (Metadata)
```dart
// Box: cache_metadata
Box<Map<String, dynamic>> _metadataBox = await Hive.openBox<Map<String, dynamic>>('cache_metadata');

å­˜å‚¨å†…å®¹:
{
  "global": {
    "recipes_last_sync": "2025-08-06T10:30:00Z",
    "preset_last_downloaded": "2025-08-06T09:15:00Z",  
    "preset_last_check": "2025-08-06T10:25:00Z"
  },
  "recipe_id_1": {
    "lastUpdated": "2025-08-06T10:20:00Z",
    "needsSync": false,
    "hasCloudUpdate": true,
    "cloudVersion": "2025-08-06T11:00:00Z"
  }
}

ç”¨é€”:
âœ… è®°å½•åŒæ­¥æ—¶é—´æˆ³
âœ… è·Ÿè¸ªæ›´æ–°çŠ¶æ€ 
âœ… æ ‡è®°åŒæ­¥å¤±è´¥é¡¹
âœ… å­˜å‚¨ç½‘ç»œé‡è¯•ä¿¡æ¯
```

#### 4. æ›´æ–°è·Ÿè¸ª (Update Tracking)
```dart
// Box: recipe_updates
Box<RecipeUpdateInfo> _updatesBox = await Hive.openBox<RecipeUpdateInfo>('recipe_updates');

æ•°æ®æ¨¡å‹:
RecipeUpdateInfo {
  recipeId: String,
  localVersion: DateTime,
  cloudVersion: DateTime,
  changedFields: List<String>,
  importance: UpdateImportance,
  isIgnored: boolean,
  checkedAt: DateTime
}

åŠŸèƒ½æ”¯æŒ:
âœ… ç‰ˆæœ¬å¯¹æ¯”æ£€æµ‹
âœ… æ›´æ–°é‡è¦æ€§åˆ†çº§
âœ… ç”¨æˆ·å¿½ç•¥è®°å½•
âœ… å˜æ›´å­—æ®µè·Ÿè¸ª
```

---

## â˜ï¸ äº‘ç«¯å­˜å‚¨æ¶æ„ (Cloud Storage)

### Firebase Firestoreæ•°æ®ç»“æ„

#### 1. ç”¨æˆ·èœè°±é›†åˆ
```
/users/{userId}/recipes/{recipeId}
{
  id: "recipe_id_1",
  name: "çº¢çƒ§è‚‰", 
  description: "ç»å…¸å®¶å¸¸èœ",
  ingredients: [...],
  steps: [...],
  createdAt: Timestamp,
  updatedAt: Timestamp,
  createdBy: "user_id",
  isPreset: false,
  tags: ["å®¶å¸¸èœ", "è‚‰ç±»"],
  cookingTime: 60,
  difficulty: "ä¸­ç­‰",
  servings: 4,
  imageUrls: [...],
  nutritionInfo: {...}
}
```

#### 2. ç”¨æˆ·æ”¶è—é›†åˆ
```
/user_favorites/{userId}
{
  userId: "user_id_1",
  favoriteRecipeIds: ["recipe_id_1", "recipe_id_2", ...],
  updatedAt: Timestamp
}
```

#### 3. é¢„è®¾èœè°±é›†åˆ (Rootç”¨æˆ·ä¸“ç”¨)
```
/users/2352016835@qq.com/recipes/{presetId}
{
  // é¢„è®¾èœè°±ç»“æ„ä¸æ™®é€šèœè°±ç›¸åŒ
  isPreset: true,
  createdBy: "2352016835@qq.com",
  // 12ä¸ªç²¾é€‰é¢„è®¾èœè°±ï¼Œå¸¦emojiå›¾æ ‡
}
```

### è®¿é—®æƒé™è®¾è®¡ (Security Rules)
```javascript
// Firestore Security Rules
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„èœè°±
    match /users/{userId}/recipes/{recipeId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // æ‰€æœ‰ç”¨æˆ·å¯ä»¥è¯»å–é¢„è®¾èœè°± 
    match /users/2352016835@qq.com/recipes/{recipeId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == "2352016835@qq.com";
    }
    
    // ç”¨æˆ·åªèƒ½ç®¡ç†è‡ªå·±çš„æ”¶è—
    match /user_favorites/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
```

---

## ğŸ”„ æ ¸å¿ƒåŒæ­¥ç®—æ³•

### 1. æœ¬åœ°ä¼˜å…ˆè¯»å–ç®—æ³•
```dart
Future<List<Recipe>> getUserRecipes(String userId) async {
  // ğŸš€ ç¬¬ä¸€æ­¥ï¼šç«‹å³è¿”å›æœ¬åœ°æ•°æ® (Fast Path)
  final localRecipes = _getUserRecipesFromLocal(userId);
  
  // ğŸ”„ ç¬¬äºŒæ­¥ï¼šåå°æ£€æŸ¥äº‘ç«¯æ›´æ–° (Background Sync)
  _checkCloudUpdatesInBackground(userId);
  
  return localRecipes; // ç«‹å³è¿”å›ï¼Œä¸ç­‰å¾…äº‘ç«¯
}
```

### 2. åå°æ›´æ–°æ£€æŸ¥ç®—æ³•
```dart
void _checkCloudUpdatesInBackground(String userId) async {
  try {
    // è·å–äº‘ç«¯æ•°æ®
    final cloudRecipes = await _cloudRepository.getUserRecipes(userId);
    final localRecipes = _getUserRecipesFromLocal(userId);
    
    // æ„å»ºæ˜ å°„è¡¨ç”¨äºå¿«é€ŸæŸ¥æ‰¾
    final localRecipeMap = {for (var r in localRecipes) r.id: r};
    
    // é€ä¸€æ¯”è¾ƒç‰ˆæœ¬
    for (final cloudRecipe in cloudRecipes) {
      final localRecipe = localRecipeMap[cloudRecipe.id];
      
      if (localRecipe == null) {
        // æ–°èœè°±ï¼šæ·»åŠ åˆ°æœ¬åœ°
        await _addRecipeToLocal(cloudRecipe);
        _notifyRecipeAdded(cloudRecipe.id);
        
      } else if (cloudRecipe.updatedAt.isAfter(localRecipe.updatedAt)) {
        // æœ‰æ›´æ–°ï¼šåˆ›å»ºæ›´æ–°ä¿¡æ¯
        await _markRecipeNeedsUpdate(cloudRecipe.id, cloudRecipe, localRecipe);
        _notifyRecipeHasUpdate(cloudRecipe.id);
        
      } else {
        // æ— å˜åŒ–ï¼šæ›´æ–°æ£€æŸ¥æ—¶é—´æˆ³
        await _updateLastChecked(cloudRecipe.id);
      }
    }
    
    // æ£€æŸ¥æœ¬åœ°æ˜¯å¦æœ‰äº‘ç«¯å·²åˆ é™¤çš„é¡¹ç›®
    _checkDeletedRecipes(cloudRecipes, localRecipes);
    
  } catch (e) {
    // é™é»˜å¤±è´¥ï¼Œè®°å½•é”™è¯¯ä½†ä¸å½±å“ç”¨æˆ·ä½“éªŒ
    _logSyncError('Background sync failed', e);
  }
}
```

### 3. æ™ºèƒ½ç‰ˆæœ¬å¯¹æ¯”ç®—æ³•
```dart
RecipeUpdateInfo _analyzeRecipeChanges(Recipe local, Recipe cloud) {
  final changedFields = <String>[];
  
  // æ£€æŸ¥å„ä¸ªå­—æ®µçš„å˜åŒ–
  if (local.name != cloud.name) changedFields.add('name');
  if (local.description != cloud.description) changedFields.add('description');
  if (!_listEquals(local.ingredients, cloud.ingredients)) changedFields.add('ingredients');
  if (!_listEquals(local.steps, cloud.steps)) changedFields.add('steps');
  if (!_listEquals(local.imageUrls, cloud.imageUrls)) changedFields.add('images');
  if (local.cookingTime != cloud.cookingTime) changedFields.add('cookingTime');
  if (local.difficulty != cloud.difficulty) changedFields.add('difficulty');
  
  // æ ¹æ®å˜åŒ–ç¡®å®šé‡è¦æ€§
  final importance = _determineUpdateImportance(changedFields);
  
  return RecipeUpdateInfo(
    recipeId: cloud.id,
    localVersion: local.updatedAt,
    cloudVersion: cloud.updatedAt, 
    changedFields: changedFields,
    importance: importance,
    checkedAt: DateTime.now(),
  );
}

UpdateImportance _determineUpdateImportance(List<String> changedFields) {
  // å…³é”®å†…å®¹å˜æ›´ = é‡è¦æ›´æ–°
  if (changedFields.any((field) => ['name', 'ingredients', 'steps'].contains(field))) {
    return UpdateImportance.important;
  }
  // ä»…æè¿°æˆ–æ—¶é—´å˜æ›´ = æ™®é€šæ›´æ–°  
  return UpdateImportance.normal;
}
```

### 4. å†²çªè§£å†³ç­–ç•¥
```dart
enum ConflictResolution {
  cloudWins,    // äº‘ç«¯ä¼˜å…ˆï¼ˆé»˜è®¤ï¼‰
  localWins,    // æœ¬åœ°ä¼˜å…ˆ
  userChoose,   // ç”¨æˆ·é€‰æ‹©
  merge,        // æ™ºèƒ½åˆå¹¶
}

Future<Recipe> resolveConflict(Recipe local, Recipe cloud, ConflictResolution strategy) async {
  switch (strategy) {
    case ConflictResolution.cloudWins:
      return cloud;
      
    case ConflictResolution.localWins:
      return local.copyWith(updatedAt: DateTime.now());
      
    case ConflictResolution.userChoose:
      // æ˜¾ç¤ºå¯¹æ¯”ç•Œé¢è®©ç”¨æˆ·é€‰æ‹©
      return await _showConflictDialog(local, cloud);
      
    case ConflictResolution.merge:
      // æ™ºèƒ½åˆå¹¶ï¼šéå†²çªå­—æ®µåˆå¹¶ï¼Œå†²çªå­—æ®µäº‘ç«¯ä¼˜å…ˆ
      return _mergeRecipes(local, cloud);
  }
}
```

---

## ğŸ”„ ç½‘ç»œé‡è¯•æœºåˆ¶

### é‡è¯•ç­–ç•¥è®¾è®¡
```dart
class NetworkRetry {
  // MVPé‡è¯•ç­–ç•¥ï¼šå¿«é€Ÿå¤±è´¥ï¼Œå‡å°‘ç­‰å¾…
  static Future<T> mvpRetry<T>(Future<T> Function() operation) async {
    const maxAttempts = 2;
    const delays = [Duration(milliseconds: 500), Duration(milliseconds: 750)];
    
    for (int attempt = 0; attempt < maxAttempts; attempt++) {
      try {
        return await operation();
      } catch (e) {
        if (!_isRetryableError(e) || attempt == maxAttempts - 1) {
          throw e; // æœ€åä¸€æ¬¡å°è¯•æˆ–ä¸å¯é‡è¯•é”™è¯¯
        }
        
        await Future.delayed(delays[attempt]);
        print('ğŸ”„ ç½‘ç»œè¯·æ±‚é‡è¯• ${attempt + 1}/$maxAttempts');
      }
    }
    
    throw Exception('é‡è¯•æ¬¡æ•°å·²ç”¨å®Œ');
  }
  
  // ä¼ä¸šçº§é‡è¯•ç­–ç•¥ï¼šæ›´å¤šé‡è¯•ï¼ŒæŒ‡æ•°é€€é¿
  static Future<T> enterpriseRetry<T>(Future<T> Function() operation) async {
    const maxAttempts = 3;
    const baseDelay = Duration(milliseconds: 1000);
    
    for (int attempt = 0; attempt < maxAttempts; attempt++) {
      try {
        return await operation();
      } catch (e) {
        if (!_isRetryableError(e) || attempt == maxAttempts - 1) {
          throw e;
        }
        
        // æŒ‡æ•°é€€é¿ï¼š1ç§’ã€2ç§’ã€4ç§’
        final delay = Duration(milliseconds: baseDelay.inMilliseconds * (1 << attempt));
        await Future.delayed(delay);
        print('ğŸ”„ ä¼ä¸šçº§é‡è¯• ${attempt + 1}/$maxAttemptsï¼Œå»¶è¿Ÿ: ${delay.inMilliseconds}ms');
      }
    }
    
    throw Exception('ä¼ä¸šçº§é‡è¯•å¤±è´¥');
  }
  
  // åˆ¤æ–­é”™è¯¯æ˜¯å¦å¯é‡è¯•
  static bool _isRetryableError(dynamic error) {
    if (error is SocketException) return true;  // ç½‘ç»œè¿æ¥é—®é¢˜
    if (error is TimeoutException) return true; // è¶…æ—¶
    if (error is HttpException) return true;    // HTTPé”™è¯¯
    if (error.toString().contains('network')) return true; // é€šç”¨ç½‘ç»œé”™è¯¯
    
    return false; // é€»è¾‘é”™è¯¯ã€æƒé™é”™è¯¯ç­‰ä¸é‡è¯•
  }
}
```

### é‡è¯•ä½¿ç”¨åœºæ™¯
```dart
// ğŸ”„ é‡è¦æ•°æ®åŒæ­¥ä½¿ç”¨ä¼ä¸šçº§é‡è¯•
final cloudUser = await NetworkRetry.enterpriseRetry(
  () => _userRepository.getUser(userId),
);

// ğŸš€ ç”¨æˆ·æ“ä½œä½¿ç”¨MVPé‡è¯•ï¼ˆå¿«é€Ÿå“åº”ï¼‰  
final success = await NetworkRetry.mvpRetry(
  () => _favoritesService.addFavorite(userId, recipeId),
);

// ğŸ“Š åå°æ•°æ®æ£€æŸ¥ä½¿ç”¨MVPé‡è¯•ï¼ˆé™é»˜å¤±è´¥ï¼‰
final updates = await NetworkRetry.mvpRetry(
  () => _checkForUpdates(userId),
).catchError((e) => []; // é™é»˜å¤±è´¥ï¼Œè¿”å›ç©ºåˆ—è¡¨
```

---

## ğŸ¯ æ›´æ–°æ£€æµ‹ä¸æç¤ºç³»ç»Ÿ

### æ›´æ–°æ£€æµ‹æœºåˆ¶
```dart
class UpdateDetectionService {
  /// ğŸ” æ£€æµ‹èœè°±æ›´æ–°
  Future<List<RecipeUpdateInfo>> detectUpdates(String userId) async {
    final updates = <RecipeUpdateInfo>[];
    
    // è·å–æœ¬åœ°å’Œäº‘ç«¯æ•°æ®
    final localRecipes = await _getLocalRecipes(userId);
    final cloudRecipes = await _getCloudRecipes(userId);
    
    // æ„å»ºæœ¬åœ°èœè°±æ˜ å°„
    final localMap = {for (var r in localRecipes) r.id: r};
    
    for (final cloudRecipe in cloudRecipes) {
      final localRecipe = localMap[cloudRecipe.id];
      
      if (localRecipe != null && 
          cloudRecipe.updatedAt.isAfter(localRecipe.updatedAt)) {
        
        // åˆ†ææ›´æ–°è¯¦æƒ…
        final updateInfo = _analyzeRecipeChanges(localRecipe, cloudRecipe);
        updates.add(updateInfo);
        
        // ä¿å­˜æ›´æ–°ä¿¡æ¯åˆ°æœ¬åœ°
        await _saveUpdateInfo(updateInfo);
      }
    }
    
    return updates;
  }
  
  /// ğŸ¨ ç”Ÿæˆæ›´æ–°UIæ ‡è®°
  Widget buildUpdateBadge(RecipeUpdateInfo updateInfo) {
    return RecipeUpdateBadge(
      label: updateInfo.updateLabel,
      color: updateInfo.badgeColor,
      isImportant: updateInfo.isImportantUpdate,
      onTap: () => _showUpdateDialog(updateInfo),
    );
  }
  
  /// ğŸ“± æ˜¾ç¤ºæ›´æ–°é¢„è§ˆå¯¹è¯æ¡†
  Future<UpdateAction?> _showUpdateDialog(RecipeUpdateInfo updateInfo) async {
    return showDialog<UpdateAction>(
      context: context,
      builder: (context) => UpdatePreviewDialog(
        updateInfo: updateInfo,
        onUpdate: () => Navigator.pop(context, UpdateAction.update),
        onIgnore: () => Navigator.pop(context, UpdateAction.ignore),
        onPreview: () => Navigator.pop(context, UpdateAction.preview),
      ),
    );
  }
}
```

### UIæ›´æ–°æç¤ºç»„ä»¶
```dart
class RecipeUpdateBadge extends StatefulWidget {
  final String label;
  final UpdateBadgeColor color;
  final bool isImportant;
  final VoidCallback? onTap;
  
  @override
  Widget build(BuildContext context) {
    return Positioned(
      top: 8,
      right: 8,
      child: BreathingWidget( // å‘¼å¸åŠ¨ç”»çªå‡ºé‡è¦æ›´æ–°
        duration: Duration(seconds: isImportant ? 2 : 4),
        child: GestureDetector(
          onTap: () {
            HapticFeedback.lightImpact();
            onTap?.call();
          },
          child: Container(
            padding: EdgeInsets.symmetric(horizontal: 8, vertical: 4),
            decoration: BoxDecoration(
              gradient: _getGradientForColor(color),
              borderRadius: BorderRadius.circular(12),
              boxShadow: [
                BoxShadow(
                  color: _getGradientForColor(color).colors.first.withOpacity(0.3),
                  blurRadius: 8,
                  offset: Offset(0, 2),
                ),
              ],
            ),
            child: Row(
              mainAxisSize: MainAxisSize.min,
              children: [
                Icon(
                  isImportant ? Icons.priority_high : Icons.fiber_new,
                  size: 12,
                  color: Colors.white,
                ),
                SizedBox(width: 4),
                Text(
                  label,
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: 10,
                    fontWeight: FontWeight.w500,
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }
}
```

---

## ğŸ§ª æµ‹è¯•æ–¹æ¡ˆä¸ç­–ç•¥

### 1. å•ç”¨æˆ·æµ‹è¯•å·¥å…· (SyncDebugScreen)

æˆ‘ä»¬å®ç°äº†ä¸€ä¸ªå®Œæ•´çš„å•ç”¨æˆ·æµ‹è¯•å·¥å…·ï¼Œè§£å†³äº†ä¼ ç»Ÿéœ€è¦åŒè´¦æˆ·æµ‹è¯•çš„é—®é¢˜ï¼š

#### æµ‹è¯•å·¥å…·åŠŸèƒ½
```dart
class SyncDebugScreen extends ConsumerStatefulWidget {
  // ğŸ“Š å®æ—¶ç¼“å­˜çŠ¶æ€ç›‘æ§
  Map<String, int> getCacheStats() {
    return {
      'userRecipes': _recipesBox?.length ?? 0,
      'presetRecipes': _presetBox?.length ?? 0, 
      'favoriteUsers': _favoritesBox?.length ?? 0,
      'metadata': _metadataBox?.length ?? 0,
      'updateInfo': _updatesBox?.length ?? 0,
    };
  }
  
  // ğŸ›ï¸ æ ¸å¿ƒæµ‹è¯•æ“ä½œ
  Widget _buildTestActions(String userId, bool isDark) {
    return GridView.count(
      crossAxisCount: 2,
      children: [
        _CompactButton(emoji: 'ğŸ”„', title: 'ç™»å½•åŒæ­¥', onTap: () => _testLoginSync(userId)),
        _CompactButton(emoji: 'ğŸ’–', title: 'æ”¶è—åŠŸèƒ½', onTap: () => _testFavorites(userId)),
        _CompactButton(emoji: 'ğŸŒŸ', title: 'é¢„è®¾èœè°±', onTap: () => _testPresetRecipes()),
        _CompactButton(emoji: 'ğŸ”', title: 'æ›´æ–°æ£€æµ‹', onTap: () => _testUpdateDetection()),
        _CompactButton(emoji: 'ğŸ§¹', title: 'æ¸…ç©ºç¼“å­˜', onTap: () => _clearAllCache()),
        _CompactButton(emoji: 'ğŸ“±', title: 'é‡ç½®çŠ¶æ€', onTap: () => _resetAppState()),
      ],
    );
  }
  
  // ğŸ“ å®æ—¶æµ‹è¯•æ—¥å¿—
  Widget _buildTestLog() {
    return Container(
      height: 300,
      child: ListView.builder(
        reverse: true, // æ–°æ¶ˆæ¯åœ¨åº•éƒ¨
        itemCount: _testLogs.length,
        itemBuilder: (context, index) {
          final log = _testLogs[index];
          return Padding(
            padding: EdgeInsets.symmetric(vertical: 2),
            child: Text(
              log,
              style: TextStyle(
                fontSize: 12,
                fontFamily: 'monospace',
                color: _getLogColor(log),
              ),
            ),
          );
        },
      ),
    );
  }
}
```

#### æµ‹è¯•è¦†ç›–åœºæ™¯
```dart
// ğŸ”„ ç™»å½•æ•°æ®åŒæ­¥æµ‹è¯•
Future<void> _testLoginSync(String userId) async {
  _addLog('ğŸš€ å¼€å§‹ç™»å½•æ•°æ®åŒæ­¥æµ‹è¯•...');
  final stopwatch = Stopwatch()..start();
  
  try {
    // å¹¶å‘åŒæ­¥ä¸‰ç§æ•°æ®
    final futures = [
      cacheService.getUserRecipes(userId),
      cacheService.getFavoriteRecipes(userId), 
      cacheService.getPresetRecipes(),
    ];
    
    final results = await Future.wait(futures);
    stopwatch.stop();
    
    _addLog('âœ… åŒæ­¥å®Œæˆ! ç”¨æ—¶: ${stopwatch.elapsedMilliseconds}ms');
    _addLog('ğŸ“Š ç”¨æˆ·èœè°±: ${results[0].length} ä¸ª');
    _addLog('ğŸ’– æ”¶è—èœè°±: ${results[1].length} ä¸ª');
    _addLog('ğŸŒŸ é¢„è®¾èœè°±: ${results[2].length} ä¸ª');
    
  } catch (e) {
    stopwatch.stop();
    _addLog('âŒ åŒæ­¥å¤±è´¥: $e');
  }
}

// ğŸ’– æ”¶è—åŠŸèƒ½å®Œæ•´æµ‹è¯•
Future<void> _testFavorites(String userId) async {
  _addLog('ğŸ’– å¼€å§‹æ”¶è—åŠŸèƒ½æµ‹è¯•...');
  
  try {
    // è·å–å½“å‰æ”¶è—
    final favorites = await cacheService.getFavoriteRecipes(userId);
    _addLog('ğŸ“Š å½“å‰æ”¶è—: ${favorites.length} ä¸ª');
    
    // æ˜¾ç¤ºæ”¶è—è¯¦æƒ…
    for (final recipe in favorites.take(5)) {
      final type = recipe.isPreset ? 'é¢„è®¾' : 'ç”¨æˆ·';
      _addLog('  â€¢ ${recipe.name} (${type}èœè°±)');
    }
    
    if (favorites.isEmpty) {
      _addLog('ğŸ’¡ æç¤º: è¯·å…ˆåœ¨ä¸»é¡µæ”¶è—ä¸€äº›èœè°±');
    }
    
  } catch (e) {
    _addLog('âŒ æ”¶è—æµ‹è¯•å¤±è´¥: $e');
  }
}

// ğŸ” æ›´æ–°æ£€æµ‹æ¨¡æ‹Ÿæµ‹è¯•
Future<void> _testUpdateDetection() async {
  _addLog('ğŸ” åˆ›å»ºæ¨¡æ‹Ÿæ›´æ–°ä¿¡æ¯...');
  
  // åˆ›å»ºæ¨¡æ‹Ÿæ›´æ–°
  final mockUpdate = RecipeUpdateInfo(
    recipeId: 'mock_recipe_123',
    localVersion: DateTime.now().subtract(Duration(hours: 2)),
    cloudVersion: DateTime.now(),
    changedFields: ['ingredients', 'steps', 'images'],
    importance: UpdateImportance.important,
    checkedAt: DateTime.now(),
  );
  
  _addLog('âœ… æ¨¡æ‹Ÿæ›´æ–°åˆ›å»ºå®Œæˆ:');
  _addLog('  â€¢ èœè°±ID: ${mockUpdate.recipeId}');
  _addLog('  â€¢ æ›´æ–°æ ‡ç­¾: ${mockUpdate.updateLabel}');
  _addLog('  â€¢ é‡è¦æ€§: ${mockUpdate.importance.label}');
  _addLog('  â€¢ å˜æ›´å­—æ®µ: ${mockUpdate.changedFields.join(', ')}');
  _addLog('  â€¢ æ›´æ–°æ—¶é—´: ${mockUpdate.updateAgeHours} å°æ—¶å‰');
  
  _addLog('ğŸ’¡ ç†è®ºä¸Šèœè°±åˆ—è¡¨ä¼šæ˜¾ç¤ºçº¢è‰²æ›´æ–°æ ‡è®°');
}
```

### 2. è‡ªåŠ¨åŒ–æµ‹è¯•ç­–ç•¥

#### Unit Tests (å•å…ƒæµ‹è¯•)
```dart
group('LocalCacheService Tests', () {
  late LocalCacheService cacheService;
  
  setUp(() async {
    await Hive.deleteFromDisk();
    Hive.init('./test/hive_test');
    cacheService = LocalCacheService(MockRecipeRepository());
    await cacheService.initialize();
  });
  
  testWidgets('åº”è¯¥ç«‹å³è¿”å›æœ¬åœ°æ•°æ®', (tester) async {
    // å‡†å¤‡æœ¬åœ°æ•°æ®
    final mockRecipes = [_createMockRecipe('1'), _createMockRecipe('2')];
    await _seedLocalData(mockRecipes);
    
    // æ‰§è¡Œæµ‹è¯•
    final stopwatch = Stopwatch()..start();
    final result = await cacheService.getUserRecipes('test_user');
    stopwatch.stop();
    
    // éªŒè¯ç»“æœ
    expect(result.length, equals(2));
    expect(stopwatch.elapsedMilliseconds, lessThan(200)); // 200mså†…è¿”å›
  });
  
  testWidgets('åå°åŒæ­¥åº”è¯¥æ£€æµ‹åˆ°æ›´æ–°', (tester) async {
    // æ¨¡æ‹Ÿæœ¬åœ°æœ‰æ—§ç‰ˆæœ¬ï¼Œäº‘ç«¯æœ‰æ–°ç‰ˆæœ¬
    final localRecipe = _createMockRecipe('1', updatedAt: DateTime(2025, 1, 1));
    final cloudRecipe = _createMockRecipe('1', updatedAt: DateTime(2025, 8, 6));
    
    await _seedLocalData([localRecipe]);
    when(mockRepository.getUserRecipes(any)).thenAnswer((_) async => [cloudRecipe]);
    
    // æ‰§è¡ŒåŒæ­¥
    await cacheService.getUserRecipes('test_user');
    await Future.delayed(Duration(seconds: 1)); // ç­‰å¾…åå°åŒæ­¥å®Œæˆ
    
    // éªŒè¯æ›´æ–°æ£€æµ‹
    final updates = await cacheService.getAllPendingUpdates();
    expect(updates.length, equals(1));
  });
});
```

#### Integration Tests (é›†æˆæµ‹è¯•)
```dart
group('End-to-End Sync Tests', () {
  testWidgets('å®Œæ•´ç™»å½•åŒæ­¥æµç¨‹', (tester) async {
    // 1. ç”¨æˆ·ç™»å½•
    final user = await authService.signInWithEmail('test@example.com', 'password');
    expect(user, isNotNull);
    
    // 2. éªŒè¯æ•°æ®åŒæ­¥
    await tester.pumpAndSettle(Duration(seconds: 5)); // ç­‰å¾…åŒæ­¥å®Œæˆ
    
    final cacheStats = cacheService.getCacheStats();
    expect(cacheStats['userRecipes'], greaterThan(0));
    expect(cacheStats['presetRecipes'], equals(12));
    
    // 3. éªŒè¯UIæ›´æ–°
    expect(find.text('çº¢çƒ§è‚‰'), findsOneWidget); // é¢„è®¾èœè°±åº”è¯¥æ˜¾ç¤º
  });
  
  testWidgets('ç¦»çº¿æ”¶è—åŠŸèƒ½æµ‹è¯•', (tester) async {
    // 1. æ–­å¼€ç½‘ç»œ
    await _simulateOffline();
    
    // 2. æ‰§è¡Œæ”¶è—æ“ä½œ
    await tester.tap(find.byIcon(Icons.favorite_border).first);
    await tester.pumpAndSettle();
    
    // 3. éªŒè¯æœ¬åœ°ä¿å­˜æˆåŠŸ
    final favorites = await cacheService.getFavoriteRecipes(testUserId);
    expect(favorites.length, equals(1));
    
    // 4. æ¢å¤ç½‘ç»œï¼ŒéªŒè¯åŒæ­¥
    await _simulateOnline();
    await tester.pumpAndSettle(Duration(seconds: 3));
    
    // 5. éªŒè¯äº‘ç«¯åŒæ­¥æˆåŠŸ
    final cloudFavorites = await favoritesService.getFavoriteRecipeIds(testUserId);
    expect(cloudFavorites.length, equals(1));
  });
});
```

### 3. æ€§èƒ½åŸºå‡†æµ‹è¯•
```dart
group('Performance Benchmarks', () {
  testWidgets('æœ¬åœ°æ•°æ®è¯»å–æ€§èƒ½', (tester) async {
    // å‡†å¤‡1000ä¸ªèœè°±æ•°æ®
    final mockRecipes = List.generate(1000, (i) => _createMockRecipe('$i'));
    await _seedLocalData(mockRecipes);
    
    // æµ‹è¯•è¯»å–æ€§èƒ½
    final stopwatch = Stopwatch()..start();
    final result = await cacheService.getUserRecipes('test_user');
    stopwatch.stop();
    
    // æ€§èƒ½æ–­è¨€
    expect(result.length, equals(1000));
    expect(stopwatch.elapsedMilliseconds, lessThan(100)); // 100mså†…å®Œæˆ
  });
  
  testWidgets('å¹¶å‘åŒæ­¥æ€§èƒ½', (tester) async {
    final stopwatch = Stopwatch()..start();
    
    // å¹¶å‘æ‰§è¡Œå¤šç§åŒæ­¥æ“ä½œ
    await Future.wait([
      cacheService.getUserRecipes('user1'),
      cacheService.getUserRecipes('user2'), 
      cacheService.getPresetRecipes(),
      cacheService.getFavoriteRecipes('user1'),
    ]);
    
    stopwatch.stop();
    
    // å¹¶å‘æ€§èƒ½æ–­è¨€
    expect(stopwatch.elapsedMilliseconds, lessThan(3000)); // 3ç§’å†…å®Œæˆ
  });
});
```

---

## ğŸ“Š ç›‘æ§ä¸åˆ†æ

### 1. åŒæ­¥æ€§èƒ½ç›‘æ§
```dart
class SyncPerformanceMonitor {
  static final Map<String, List<Duration>> _syncTimes = {};
  static final Map<String, int> _syncErrors = {};
  
  /// è®°å½•åŒæ­¥è€—æ—¶
  static void recordSyncTime(String operation, Duration duration) {
    _syncTimes.putIfAbsent(operation, () => []).add(duration);
    
    // æ€§èƒ½å‘Šè­¦ï¼šè¶…è¿‡3ç§’çš„åŒæ­¥æ“ä½œ
    if (duration.inSeconds > 3) {
      debugPrint('âš ï¸ åŒæ­¥æ€§èƒ½å‘Šè­¦: $operation è€—æ—¶ ${duration.inMilliseconds}ms');
    }
  }
  
  /// è®°å½•åŒæ­¥é”™è¯¯
  static void recordSyncError(String operation, dynamic error) {
    _syncErrors.putIfAbsent(operation, () => 0);
    _syncErrors[operation] = _syncErrors[operation]! + 1;
    
    debugPrint('âŒ åŒæ­¥é”™è¯¯: $operation - $error');
  }
  
  /// è·å–æ€§èƒ½ç»Ÿè®¡æŠ¥å‘Š
  static Map<String, dynamic> getPerformanceReport() {
    final report = <String, dynamic>{};
    
    for (final entry in _syncTimes.entries) {
      final times = entry.value;
      final avgTime = times.map((d) => d.inMilliseconds).reduce((a, b) => a + b) / times.length;
      
      report[entry.key] = {
        'avgTime': avgTime,
        'totalCalls': times.length,
        'errors': _syncErrors[entry.key] ?? 0,
        'successRate': ((times.length - (_syncErrors[entry.key] ?? 0)) / times.length * 100).round(),
      };
    }
    
    return report;
  }
}
```

### 2. ç”¨æˆ·è¡Œä¸ºåˆ†æ
```dart
class SyncBehaviorAnalytics {
  /// è®°å½•ç”¨æˆ·åŒæ­¥è¡Œä¸º
  static void trackSyncBehavior(String action, Map<String, dynamic> properties) {
    final event = {
      'action': action,
      'timestamp': DateTime.now().toIso8601String(),
      'properties': properties,
    };
    
    // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šå‘é€åˆ°åˆ†ææœåŠ¡
    debugPrint('ğŸ“Š åŒæ­¥è¡Œä¸º: $event');
  }
  
  /// åˆ†æä½¿ç”¨æ¨¡å¼
  static void analyzeSyncPatterns() {
    // åˆ†æåŒæ­¥é¢‘ç‡ã€é”™è¯¯æ¨¡å¼ã€æ€§èƒ½è¶‹åŠ¿ç­‰
    final report = SyncPerformanceMonitor.getPerformanceReport();
    
    for (final entry in report.entries) {
      final stats = entry.value;
      print('ğŸ“ˆ ${entry.key}:');
      print('  â€¢ å¹³å‡è€—æ—¶: ${stats['avgTime']}ms');
      print('  â€¢ è°ƒç”¨æ¬¡æ•°: ${stats['totalCalls']}');
      print('  â€¢ æˆåŠŸç‡: ${stats['successRate']}%');
    }
  }
}
```

---

## ğŸš¨ æ•…éšœå¤„ç†ä¸æ¢å¤

### 1. å¸¸è§æ•…éšœåœºæ™¯
```dart
enum SyncFailureType {
  networkTimeout,     // ç½‘ç»œè¶…æ—¶
  authenticationFailed, // è®¤è¯å¤±è´¥
  storageQuotaExceeded, // å­˜å‚¨ç©ºé—´ä¸è¶³
  dataCorruption,     // æ•°æ®æŸå
  conflictResolution, // å†²çªè§£å†³å¤±è´¥
}

class SyncFailureHandler {
  /// å¤„ç†åŒæ­¥å¤±è´¥
  static Future<bool> handleSyncFailure(
    SyncFailureType failureType,
    dynamic error,
    String context,
  ) async {
    switch (failureType) {
      case SyncFailureType.networkTimeout:
        return await _handleNetworkTimeout(error, context);
        
      case SyncFailureType.authenticationFailed:
        return await _handleAuthFailure(error, context);
        
      case SyncFailureType.dataCorruption:
        return await _handleDataCorruption(error, context);
        
      default:
        return await _handleGenericFailure(error, context);
    }
  }
  
  /// ç½‘ç»œè¶…æ—¶å¤„ç†
  static Future<bool> _handleNetworkTimeout(dynamic error, String context) async {
    debugPrint('ğŸŒ ç½‘ç»œè¶…æ—¶ï¼Œå¯åŠ¨é‡è¯•æœºåˆ¶: $context');
    
    // ä½¿ç”¨ç½‘ç»œé‡è¯•æœºåˆ¶
    try {
      await NetworkRetry.mvpRetry(() => _retryFailedOperation(context));
      return true;
    } catch (e) {
      // é‡è¯•å¤±è´¥ï¼Œæ ‡è®°ä¸ºå¾…åŒæ­¥
      await _markAsPendingSync(context);
      return false;
    }
  }
  
  /// æ•°æ®æŸåæ¢å¤
  static Future<bool> _handleDataCorruption(dynamic error, String context) async {
    debugPrint('ğŸ› ï¸ æ£€æµ‹åˆ°æ•°æ®æŸåï¼Œå¯åŠ¨æ¢å¤ç¨‹åº: $context');
    
    try {
      // 1. å¤‡ä»½æŸåçš„æ•°æ®
      await _backupCorruptedData(context);
      
      // 2. æ¸…ç©ºæœ¬åœ°ç¼“å­˜
      await _clearLocalCache();
      
      // 3. ä»äº‘ç«¯é‡æ–°åŒæ­¥
      await _performFullSync();
      
      debugPrint('âœ… æ•°æ®æ¢å¤å®Œæˆ');
      return true;
      
    } catch (e) {
      debugPrint('âŒ æ•°æ®æ¢å¤å¤±è´¥: $e');
      return false;
    }
  }
}
```

### 2. è‡ªåŠ¨æ¢å¤æœºåˆ¶
```dart
class AutoRecoveryService {
  static const int maxRecoveryAttempts = 3;
  static const Duration recoveryDelay = Duration(minutes: 5);
  
  /// å¯åŠ¨è‡ªåŠ¨æ¢å¤
  static void startAutoRecovery() {
    Timer.periodic(recoveryDelay, (timer) async {
      await _checkAndRecover();
    });
  }
  
  /// æ£€æŸ¥å¹¶æ¢å¤å¤±è´¥çš„åŒæ­¥
  static Future<void> _checkAndRecover() async {
    try {
      // è·å–å¾…åŒæ­¥çš„é¡¹ç›®
      final pendingItems = await _getPendingSyncItems();
      
      if (pendingItems.isNotEmpty) {
        debugPrint('ğŸ”„ å‘ç° ${pendingItems.length} ä¸ªå¾…åŒæ­¥é¡¹ç›®ï¼Œå¼€å§‹è‡ªåŠ¨æ¢å¤...');
        
        for (final item in pendingItems) {
          await _recoverSyncItem(item);
        }
      }
      
    } catch (e) {
      debugPrint('âš ï¸ è‡ªåŠ¨æ¢å¤è¿‡ç¨‹ä¸­å‡ºé”™: $e');
    }
  }
  
  /// æ¢å¤å•ä¸ªåŒæ­¥é¡¹ç›®
  static Future<void> _recoverSyncItem(SyncItem item) async {
    if (item.attemptCount >= maxRecoveryAttempts) {
      debugPrint('âŒ é¡¹ç›® ${item.id} æ¢å¤æ¬¡æ•°å·²è¾¾ä¸Šé™ï¼Œæ ‡è®°ä¸ºå¤±è´¥');
      await _markAsPermanentFailure(item);
      return;
    }
    
    try {
      await NetworkRetry.mvpRetry(() => _executeSyncItem(item));
      await _markAsRecovered(item);
      debugPrint('âœ… é¡¹ç›® ${item.id} æ¢å¤æˆåŠŸ');
      
    } catch (e) {
      item.attemptCount++;
      await _updateSyncItem(item);
      debugPrint('âš ï¸ é¡¹ç›® ${item.id} æ¢å¤å¤±è´¥ï¼Œå°è¯•æ¬¡æ•°: ${item.attemptCount}');
    }
  }
}
```

---

## ğŸ”’ å®‰å…¨æ€§è®¾è®¡

### 1. æ•°æ®ä¼ è¾“å®‰å…¨
```dart
class SecureDataTransfer {
  /// åŠ å¯†æ•æ„Ÿæ•°æ®
  static String encryptSensitiveData(String data) {
    // åœ¨ä¼ä¸šçº§å®ç°ä¸­ï¼Œè¿™é‡Œä¼šä½¿ç”¨AESåŠ å¯†
    // MVPé˜¶æ®µä¾èµ–Firebaseçš„HTTPSä¼ è¾“å®‰å…¨
    return data; // MVP: æ˜æ–‡ä¼ è¾“ï¼Œä¾èµ–HTTPS
  }
  
  /// éªŒè¯æ•°æ®å®Œæ•´æ€§
  static bool verifyDataIntegrity(String data, String checksum) {
    // ä¼ä¸šçº§ï¼šè®¡ç®—å¹¶éªŒè¯æ•°æ®å“ˆå¸Œ
    // MVP: è·³è¿‡å®Œæ•´æ€§éªŒè¯
    return true; // MVP: å‡è®¾æ•°æ®å®Œæ•´
  }
  
  /// APIè¯·æ±‚ç­¾å
  static String signRequest(Map<String, dynamic> request) {
    // ä¼ä¸šçº§ï¼šä½¿ç”¨HMAC-SHA256ç­¾åAPIè¯·æ±‚
    // MVP: ä¾èµ–Firebase Auth token
    return ''; // MVP: æ— é¢å¤–ç­¾å
  }
}
```

### 2. æœ¬åœ°æ•°æ®ä¿æŠ¤
```dart
class LocalDataSecurity {
  /// åŠ å¯†æœ¬åœ°å­˜å‚¨
  static Future<void> encryptLocalStorage() async {
    // ä¼ä¸šçº§ï¼šä½¿ç”¨è®¾å¤‡å¯†é’¥åŠ å¯†Hiveæ•°æ®
    // MVP: Hiveé»˜è®¤æ— åŠ å¯†ï¼Œä¾èµ–OSæ–‡ä»¶ç³»ç»Ÿå®‰å…¨
    debugPrint('ğŸ’¾ MVP: æœ¬åœ°æ•°æ®æœªåŠ å¯†ï¼Œä¾èµ–ç³»ç»Ÿå®‰å…¨');
  }
  
  /// æ¸…ç†æ•æ„Ÿæ•°æ®
  static Future<void> cleanupSensitiveData() async {
    // å®šæœŸæ¸…ç†ä¸´æ—¶æ–‡ä»¶ã€æ—¥å¿—ä¸­çš„æ•æ„Ÿä¿¡æ¯
    await _clearTempFiles();
    await _sanitizeLogs();
  }
  
  /// æ£€æµ‹åº”ç”¨å®Œæ•´æ€§
  static bool detectTampering() {
    // ä¼ä¸šçº§ï¼šæ£€æµ‹åº”ç”¨æ˜¯å¦è¢«ç¯¡æ”¹
    // MVP: ä¾èµ–åº”ç”¨å•†åº—å’ŒOSçš„å®Œæ•´æ€§æ£€æŸ¥
    return false; // MVP: å‡è®¾åº”ç”¨å®Œæ•´
  }
}
```

---

## ğŸ¯ MVP vs ä¼ä¸šçº§å¯¹æ¯”

### åŠŸèƒ½å¯¹æ¯”è¡¨

| åŠŸèƒ½é¢†åŸŸ | MVPå®ç° | ä¼ä¸šçº§å®ç° |
|---------|---------|------------|
| **æ•°æ®ä¼ è¾“** | HTTPS + Firebase Auth | HTTPS + è¯·æ±‚ç­¾å + ç«¯åˆ°ç«¯åŠ å¯† |
| **æœ¬åœ°å­˜å‚¨** | Hiveæ˜æ–‡å­˜å‚¨ | AES-256åŠ å¯†å­˜å‚¨ |
| **ç½‘ç»œé‡è¯•** | 2æ¬¡é‡è¯•ï¼Œç®€å•å»¶è¿Ÿ | 3æ¬¡é‡è¯•ï¼ŒæŒ‡æ•°é€€é¿ï¼Œç†”æ–­å™¨ |
| **å†²çªè§£å†³** | äº‘ç«¯ä¼˜å…ˆ | æ™ºèƒ½åˆå¹¶ + ç”¨æˆ·é€‰æ‹© |
| **ç›‘æ§åˆ†æ** | åŸºç¡€æ—¥å¿— | å®Œæ•´metrics + å‘Šè­¦ç³»ç»Ÿ |
| **æ•…éšœæ¢å¤** | æ‰‹åŠ¨é‡è¯• | è‡ªåŠ¨æ¢å¤ + æ•°æ®ä¿®å¤ |
| **æƒé™æ§åˆ¶** | Firebaseè§„åˆ™ | RBAC + ç»†ç²’åº¦æƒé™ |
| **å®¡è®¡æ—¥å¿—** | å¼€å‘æ—¥å¿— | å®Œæ•´å®¡è®¡ + åˆè§„æŠ¥å‘Š |

### æ€§èƒ½æŒ‡æ ‡å¯¹æ¯”

| æŒ‡æ ‡ | MVPç›®æ ‡ | ä¼ä¸šçº§ç›®æ ‡ |
|------|--------|-----------|
| **é¦–å±åŠ è½½** | <500ms | <200ms |
| **æ•°æ®åŒæ­¥** | <3ç§’ | <1ç§’ |
| **ç¦»çº¿æ”¯æŒ** | åŸºç¡€ç¼“å­˜ | å®Œå…¨ç¦»çº¿æ“ä½œ |
| **å¹¶å‘ç”¨æˆ·** | <1000 | <100,000 |
| **æ•°æ®ä¸€è‡´æ€§** | æœ€ç»ˆä¸€è‡´ | å¼ºä¸€è‡´æ€§ |
| **æ•…éšœæ¢å¤** | æ‰‹åŠ¨ | <30ç§’è‡ªåŠ¨æ¢å¤ |

---

## ğŸ“š APIæ¥å£æ–‡æ¡£

### CachedRecipeServiceæ ¸å¿ƒAPI

```dart
class CachedRecipeService {
  /// ğŸ”„ è·å–ç”¨æˆ·èœè°±ï¼ˆæœ¬åœ°ä¼˜å…ˆï¼‰
  /// è¿”å›: ç«‹å³è¿”å›æœ¬åœ°æ•°æ®ï¼Œåå°æ£€æŸ¥æ›´æ–°
  /// æ€§èƒ½: <200mså“åº”æ—¶é—´
  Future<List<Recipe>> getUserRecipes(String userId, {bool forceRefresh = false});
  
  /// â­ è·å–æ”¶è—èœè°±
  /// è¿”å›: ç”¨æˆ·æ”¶è—çš„èœè°±è¯¦æƒ…åˆ—è¡¨
  /// ç¼“å­˜: æœ¬åœ°ç¼“å­˜ä¼˜å…ˆï¼Œæ”¯æŒç¦»çº¿æŸ¥çœ‹
  Future<List<Recipe>> getFavoriteRecipes(String userId, {bool forceRefresh = false});
  
  /// ğŸ“š è·å–é¢„è®¾èœè°±
  /// è¿”å›: Rootç”¨æˆ·åˆ›å»ºçš„12ä¸ªé¢„è®¾èœè°±
  /// ç¼“å­˜: é¦–æ¬¡ä¸‹è½½åæœ¬åœ°è®¿é—®ï¼Œæ¯å‘¨æ£€æŸ¥æ›´æ–°
  Future<List<Recipe>> getPresetRecipes({bool forceRefresh = false});
  
  /// ğŸ’¾ ä¿å­˜èœè°±ï¼ˆåŒå†™ç­–ç•¥ï¼‰
  /// è¡Œä¸º: ç«‹å³ä¿å­˜æœ¬åœ°ï¼Œå¼‚æ­¥åŒæ­¥äº‘ç«¯
  /// å“åº”: æœ¬åœ°æˆåŠŸå³è¿”å›ï¼Œä¸ç­‰å¾…äº‘ç«¯
  Future<void> saveRecipe(Recipe recipe, String userId);
  
  /// ğŸ” æ£€æŸ¥å¾…æ›´æ–°é¡¹ç›®
  /// è¿”å›: éœ€è¦æ›´æ–°çš„èœè°±IDåˆ—è¡¨
  /// ç”¨é€”: UIæ˜¾ç¤ºæ›´æ–°æ ‡è®°
  List<String> getAllPendingUpdates();
  
  /// ğŸ§¹ æ¸…ç©ºæœ¬åœ°ç¼“å­˜
  /// è¡Œä¸º: æ¸…é™¤æ‰€æœ‰æœ¬åœ°æ•°æ®ï¼Œä¿ç•™å…ƒæ•°æ®
  /// ç”¨é€”: æ•…éšœæ¢å¤ã€å­˜å‚¨ç©ºé—´ç®¡ç†
  Future<void> clearCache();
}
```

### NetworkRetryç½‘ç»œé‡è¯•API

```dart
class NetworkRetry {
  /// ğŸš€ MVPé‡è¯•ç­–ç•¥
  /// å‚æ•°: å¼‚æ­¥æ“ä½œå‡½æ•°
  /// è¡Œä¸º: æœ€å¤šé‡è¯•2æ¬¡ï¼Œå»¶è¿Ÿ500msã€750ms
  /// é€‚ç”¨: ç”¨æˆ·æ“ä½œã€è½»é‡çº§åŒæ­¥
  static Future<T> mvpRetry<T>(Future<T> Function() operation);
  
  /// ğŸ¢ ä¼ä¸šçº§é‡è¯•ç­–ç•¥
  /// å‚æ•°: å¼‚æ­¥æ“ä½œå‡½æ•°
  /// è¡Œä¸º: æœ€å¤šé‡è¯•3æ¬¡ï¼ŒæŒ‡æ•°é€€é¿1sã€2sã€4s
  /// é€‚ç”¨: é‡è¦æ•°æ®åŒæ­¥ã€å…³é”®æ“ä½œ
  static Future<T> enterpriseRetry<T>(Future<T> Function() operation);
  
  /// ğŸ” é”™è¯¯ç±»å‹åˆ¤æ–­
  /// è¿”å›: æ˜¯å¦ä¸ºå¯é‡è¯•çš„ç½‘ç»œé”™è¯¯
  /// é€»è¾‘: ç½‘ç»œå¼‚å¸¸é‡è¯•ï¼Œä¸šåŠ¡å¼‚å¸¸ä¸é‡è¯•
  static bool isRetryableError(dynamic error);
}
```

---

## ğŸ”§ éƒ¨ç½²ä¸è¿ç»´

### 1. Firebaseé…ç½®

#### Firestoreç´¢å¼•é…ç½®
```javascript
// firestore.indexes.json
{
  "indexes": [
    {
      "collectionGroup": "recipes",
      "queryScope": "COLLECTION",
      "fields": [
        {"fieldPath": "createdBy", "order": "ASCENDING"},
        {"fieldPath": "updatedAt", "order": "DESCENDING"}
      ]
    },
    {
      "collectionGroup": "recipes", 
      "queryScope": "COLLECTION",
      "fields": [
        {"fieldPath": "isPreset", "order": "ASCENDING"},
        {"fieldPath": "createdAt", "order": "DESCENDING"}
      ]
    }
  ]
}
```

#### å®‰å…¨è§„åˆ™é…ç½®
```javascript
// firestore.rules
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ç”¨æˆ·èœè°±ï¼šä»…é™æœ¬äººè®¿é—®
    match /users/{userId}/recipes/{recipeId} {
      allow read, write: if request.auth != null 
        && request.auth.uid == userId;
    }
    
    // é¢„è®¾èœè°±ï¼šæ‰€æœ‰äººå¯è¯»ï¼Œä»…Rootå¯å†™
    match /users/2352016835@qq.com/recipes/{recipeId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null 
        && request.auth.uid == "2352016835@qq.com";
    }
    
    // ç”¨æˆ·æ”¶è—ï¼šä»…é™æœ¬äººç®¡ç†
    match /user_favorites/{userId} {
      allow read, write: if request.auth != null 
        && request.auth.uid == userId;
    }
  }
}
```

### 2. æ€§èƒ½ä¼˜åŒ–é…ç½®

#### Flutteråº”ç”¨é…ç½®
```yaml
# pubspec.yaml
dependencies:
  flutter:
    sdk: flutter
  hive: ^2.2.3
  hive_flutter: ^1.1.0
  firebase_core: ^2.15.0
  cloud_firestore: ^4.8.4
  flutter_riverpod: ^2.3.6

dev_dependencies:
  hive_generator: ^2.0.0
  build_runner: ^2.4.6

flutter:
  uses-material-design: true
  
  # èµ„æºé¢„åŠ è½½ä¼˜åŒ–
  assets:
    - assets/images/
    - assets/icons/
    
  # å­—ä½“é¢„åŠ è½½
  fonts:
    - family: CustomFont
      fonts:
        - asset: fonts/CustomFont-Regular.ttf
        - asset: fonts/CustomFont-Light.ttf
          weight: 300
```

#### æ„å»ºä¼˜åŒ–
```bash
# ç”Ÿäº§ç¯å¢ƒæ„å»ºå‘½ä»¤
flutter build apk --release --shrink --obfuscate --split-debug-info=build/debug-info/

# Webæ„å»ºä¼˜åŒ–
flutter build web --release --web-renderer html --pwa-strategy offline-first

# æ€§èƒ½åˆ†ææ„å»º
flutter build apk --profile --enable-software-rendering
```

---

## ğŸ“ˆ æœªæ¥æ‰©å±•è®¡åˆ’

### 1. ä¼ä¸šçº§åŠŸèƒ½è·¯çº¿å›¾

#### Phase 1: é«˜çº§åŒæ­¥ (Q2 2025)
- [ ] å®æ—¶ååŒç¼–è¾‘æ”¯æŒ
- [ ] å¤æ‚å†²çªè§£å†³ç®—æ³•
- [ ] å¤šè®¾å¤‡çŠ¶æ€åŒæ­¥
- [ ] å¢é‡æ•°æ®ä¼ è¾“

#### Phase 2: å®‰å…¨å¢å¼º (Q3 2025) 
- [ ] ç«¯åˆ°ç«¯æ•°æ®åŠ å¯†
- [ ] APIè¯·æ±‚ç­¾åéªŒè¯
- [ ] è®¾å¤‡æŒ‡çº¹è¯†åˆ«
- [ ] å®Œæ•´å®¡è®¡æ—¥å¿—ç³»ç»Ÿ

#### Phase 3: æ™ºèƒ½åˆ†æ (Q4 2025)
- [ ] ç”¨æˆ·è¡Œä¸ºåˆ†æ
- [ ] æ™ºèƒ½æ¨èç³»ç»Ÿ
- [ ] æ€§èƒ½è‡ªä¼˜åŒ–
- [ ] é¢„æµ‹æ€§æ•…éšœæ£€æµ‹

### 2. æŠ€æœ¯å€ºåŠ¡æ¸…ç†

#### ä»£ç è´¨é‡æå‡
```dart
// TODO: é‡æ„CachedRecipeServiceä¸ºæ¨¡å—åŒ–æ¶æ„
class ModularCacheService {
  final RecipeCacheModule _recipeModule;
  final FavoritesCacheModule _favoritesModule;
  final PresetCacheModule _presetModule;
  final SyncCoordinatorModule _syncModule;
}

// TODO: å®ç°å®Œæ•´çš„é”™è¯¯åˆ†ç±»ç³»ç»Ÿ
enum SyncErrorCategory {
  network,      // ç½‘ç»œç›¸å…³é”™è¯¯
  storage,      // å­˜å‚¨ç›¸å…³é”™è¯¯  
  authentication, // è®¤è¯ç›¸å…³é”™è¯¯
  business,     // ä¸šåŠ¡é€»è¾‘é”™è¯¯
  system,       // ç³»ç»Ÿçº§é”™è¯¯
}

// TODO: æ·»åŠ å®Œæ•´çš„ç±»å‹å®‰å…¨
class TypeSafeUpdateInfo<T extends Recipe> {
  final String id;
  final T localVersion;
  final T cloudVersion;
  final Set<String> changedFields;
}
```

#### æ€§èƒ½ä¼˜åŒ–è®¡åˆ’
```dart
// TODO: å®ç°æ™ºèƒ½é¢„åŠ è½½
class IntelligentPreloader {
  /// æ ¹æ®ç”¨æˆ·è¡Œä¸ºé¢„æµ‹å¹¶é¢„åŠ è½½æ•°æ®
  Future<void> preloadBasedOnBehavior(UserBehaviorPattern pattern);
  
  /// åœ¨ç”¨æˆ·ç©ºé—²æ—¶è¿›è¡Œåå°æ•°æ®æ•´ç†
  Future<void> backgroundDataOptimization();
}

// TODO: å†…å­˜ä½¿ç”¨ä¼˜åŒ–
class MemoryOptimizedCache {
  /// LRUç¼“å­˜æ·˜æ±°ç­–ç•¥
  void _evictLeastRecentlyUsed();
  
  /// å†…å­˜å‹åŠ›æ—¶çš„æ•°æ®å‹ç¼©
  void _compressDataUnderPressure();
}
```

---

## ğŸ’¡ æœ€ä½³å®è·µå»ºè®®

### 1. å¼€å‘è€…ä½¿ç”¨æŒ‡å—

#### ğŸš€ å¿«é€Ÿé›†æˆæ­¥éª¤
```dart
// 1. åˆå§‹åŒ–ç¼“å­˜æœåŠ¡
final cacheService = CachedRecipeService(RecipeRepository());
await cacheService.initialize();

// 2. åœ¨Providerä¸­æ³¨å†Œ
final cacheServiceProvider = Provider<CachedRecipeService>((ref) {
  return cacheService;
});

// 3. UIä¸­ä½¿ç”¨
class RecipeListWidget extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    return FutureBuilder<List<Recipe>>(
      future: ref.read(cacheServiceProvider).getUserRecipes(userId),
      builder: (context, snapshot) {
        if (snapshot.hasData) {
          return _buildRecipeList(snapshot.data!);
        }
        return _buildLoadingIndicator();
      },
    );
  }
}
```

#### ğŸ”§ å¸¸è§é—®é¢˜è§£å†³

**Q: æ•°æ®åŒæ­¥é€Ÿåº¦æ…¢**
```dart
// A: å¯ç”¨å¹¶å‘åŒæ­¥
final futures = [
  cacheService.getUserRecipes(userId),
  cacheService.getFavoriteRecipes(userId),
  cacheService.getPresetRecipes(),
];
final results = await Future.wait(futures);
```

**Q: ç½‘ç»œå¼‚å¸¸å¤„ç†**
```dart
// A: ä½¿ç”¨é‡è¯•æœºåˆ¶
try {
  final recipes = await NetworkRetry.mvpRetry(
    () => cacheService.getUserRecipes(userId, forceRefresh: true),
  );
} catch (e) {
  // æ˜¾ç¤ºå‹å¥½é”™è¯¯æç¤º
  _showNetworkError();
}
```

### 2. æ€§èƒ½è°ƒä¼˜å»ºè®®

#### ğŸ¯ å“åº”æ—¶é—´ä¼˜åŒ–
- **æœ¬åœ°æ•°æ®æŸ¥è¯¢**: æ§åˆ¶åœ¨<100ms
- **ç¼“å­˜å‘½ä¸­ç‡**: ä¿æŒ>95%
- **åå°åŒæ­¥**: ä¸é˜»å¡UIï¼Œ<3ç§’å®Œæˆ
- **ç½‘ç»œé‡è¯•**: å¤±è´¥å<1ç§’å¼€å§‹é‡è¯•

#### ğŸ“Š å†…å­˜ä½¿ç”¨ä¼˜åŒ–
- **ç¼“å­˜å¤§å°**: é™åˆ¶åœ¨50MBä»¥å†…
- **å›¾ç‰‡ç¼“å­˜**: ä½¿ç”¨å‹ç¼©å’Œåˆ†çº§ç¼“å­˜
- **åŠæ—¶æ¸…ç†**: å®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®
- **å†…å­˜ç›‘æ§**: å®æ—¶ç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µ

---

## ğŸ“ æ”¯æŒä¸åé¦ˆ

### ğŸ› é—®é¢˜æŠ¥å‘Š
å¦‚æœåœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. **ç¯å¢ƒä¿¡æ¯**
   - Flutterç‰ˆæœ¬
   - è®¾å¤‡ç±»å‹ï¼ˆiOS/Android/Webï¼‰
   - ç½‘ç»œçŠ¶å†µ

2. **é—®é¢˜æè¿°**
   - å…·ä½“æ“ä½œæ­¥éª¤
   - æœŸæœ›ç»“æœ vs å®é™…ç»“æœ
   - é”™è¯¯æ—¥å¿—

3. **é‡ç°æ­¥éª¤**
   - è¯¦ç»†çš„æ“ä½œåºåˆ—
   - æµ‹è¯•æ•°æ®
   - ç¯å¢ƒé…ç½®

### ğŸ“§ è”ç³»æ–¹å¼
- **æŠ€æœ¯æ”¯æŒ**: é€šè¿‡GitHub Issuesæäº¤
- **åŠŸèƒ½å»ºè®®**: åœ¨é¡¹ç›®è®¨è®ºåŒºæå‡º
- **ç´§æ€¥é—®é¢˜**: æŸ¥çœ‹æ•…éšœæ’é™¤æŒ‡å—

---

## ğŸ‰ ç»“è¯­

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº†"çˆ±å¿ƒé£Ÿè°±"åº”ç”¨çš„æœ¬åœ°äº‘ç«¯å¼‚æ­¥æ•°æ®åŒæ­¥ç³»ç»Ÿæ¶æ„ã€‚è¯¥ç³»ç»Ÿç»è¿‡æ·±åº¦æ€è€ƒå’Œç²¾å¿ƒè®¾è®¡ï¼Œå®ç°äº†ç”¨æˆ·æœŸæœ›çš„"ç§’å¼€å“åº”ã€æ™ºèƒ½åŒæ­¥ã€æ— æ„Ÿä½“éªŒ"ç›®æ ‡ã€‚

### ğŸ¯ æ ¸å¿ƒä»·å€¼
1. **ç”¨æˆ·ä½“éªŒè‡³ä¸Š** - æœ¬åœ°ä¼˜å…ˆç­–ç•¥ç¡®ä¿ç¬é—´å“åº”
2. **æ•°æ®å®‰å…¨å¯é ** - åŒå†™æœºåˆ¶ä¿è¯æ•°æ®ä¸ä¸¢å¤±
3. **æ™ºèƒ½å®¹é”™å¤„ç†** - ç½‘ç»œå¼‚å¸¸æ—¶è‡ªåŠ¨é‡è¯•å’Œæ¢å¤
4. **æµ‹è¯•è¦†ç›–å®Œæ•´** - å•ç”¨æˆ·æµ‹è¯•å·¥å…·æ”¯æŒå…¨åŠŸèƒ½éªŒè¯
5. **æ¶æ„æ‰©å±•æ€§å¼º** - MVPåˆ°ä¼ä¸šçº§å¹³æ»‘å‡çº§

### ğŸš€ æœªæ¥å±•æœ›
è¿™å¥—åŒæ­¥ç³»ç»Ÿä¸º"çˆ±å¿ƒé£Ÿè°±"æä¾›äº†åšå®çš„æŠ€æœ¯åŸºç¡€ï¼Œæ”¯æŒä»MVPåˆ°ä¼ä¸šçº§çš„å¹³æ»‘æ¼”è¿›ã€‚éšç€ç”¨æˆ·è§„æ¨¡å¢é•¿å’ŒåŠŸèƒ½éœ€æ±‚æ‰©å±•ï¼Œç³»ç»Ÿå¯ä»¥é€æ­¥å¢å¼ºå®‰å…¨æ€§ã€æ€§èƒ½å’Œæ™ºèƒ½åŒ–æ°´å¹³ã€‚

*"ç®€çº¦ä¸æ˜¯ç®€å•ï¼Œè€Œæ˜¯æŠŠå¤æ‚è—åœ¨ä¼˜é›…çš„è¡¨è±¡ä¹‹ä¸‹"* - è¿™æ­£æ˜¯æˆ‘ä»¬çš„è®¾è®¡ç†å¿µã€‚

---

*æ–‡æ¡£ç‰ˆæœ¬: v1.0*  
*æœ€åæ›´æ–°: 2025-08-06*  
*ä½œè€…: Claude Code*  
*é¡¹ç›®: çˆ±å¿ƒé£Ÿè°± - æç®€é«˜çº§æƒ…ä¾£èœè°±åº”ç”¨*